<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Download Packages</title>
        <style>
        h1 {text-align: center;}
        h2 {text-align: center;}
        h3 {text-align: center;}
        a {text-align: center;}
        button {text-align: center;}
        form {text-align:center;}
        .box {
            border: 3px solid black;
            padding: 50px;
            margin-top: 30px;
            margin-bottom: 30px;
        }
        button {
            display: block;
            margin: auto;
            margin-top: 20px;
        }
        select {
            display: block;
            margin: auto;
            margin-top: 20px;
        }
        .navbar {
        overflow: hidden;
        background-color: #333;
        font-family: Arial, Helvetica, sans-serif;
        }

        .navbar a {
        float: left;
        font-size: 16px;
        color: white;
        text-align: center;
        padding: 14px 16px;
        text-decoration: none;
        }

        .dropdown {
        float: left;
        overflow: hidden;
        }

        .dropdown .dropbtn {
        cursor: pointer;
        font-size: 16px;  
        border: none;
        outline: none;
        color: white;
        padding: 14px 16px;
        background-color: inherit;
        font-family: inherit;
        margin: 0;
        }

        .navbar a:hover, .dropdown:hover .dropbtn, .dropbtn:focus {
        background-color: red;
        }

        .dropdown-content {
        display: none;
        position: absolute;
        background-color: #f9f9f9;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1;
        }

        .dropdown-content a {
        float: none;
        color: black;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
        text-align: left;
        }

        .dropdown-content a:hover {
        background-color: #ddd;
        }

        .show {
        display: block;
        }
        </style>
    </head>
    <body>
        <div class="navbar">
            <a href="index.html">Home</a>
            <a href="upload.html">Upload</a>
            <a href="download.html">Download</a>
            <a href="rate.html">Rate</a>
            <a href="update.html">Update</a>
        </div>
        <div class="box">
            <h1> ACME Corp Module Registry</h1>
            <h2> Download Packages</h2>
            <h3> To download a package, use the dropdown menu to select which package you would like to download, then click the "Download" button.</h3>
        </div>
        <div>
            <select name="packages" id="packages">
                <option value="volvo">Volvo</option>
                <option value="saab">Saab</option>
            </select>
            
            <button id="updateButton">Update Data</button>

            <button onclick="window.location.href='index.html';">
                Return to Home
            </button>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/index.min.js"></script> -->

        <script>
            const updateButton = document.getElementById('updateButton');

            updateButton.addEventListener('click', () => {
            updateData()
                .then(data => console.log(data))
                .catch(error => console.error(error));
            });

            //function updateData() {
            // return new Promise((resolve, reject) => {
            //     fetch('http://localhost:3000/package/64401f562953ae67a2ef6a32', {
            //     method: 'GET',
            //     headers: {
            //         'Content-Type': 'application/json'
            //     }//,
            //     //body: JSON.stringify({"key": "value"})
            //     })
            //     .then(response => response.json())
            //     .then(data => resolve(data))
            //     .catch(error => reject(error));
            // });
            //}
            // async function updateData() {
            //     const response = await fetch('http://localhost:3000/package/64401f562953ae67a2ef6a32');
            //     const data = await response.json();
                
            //     const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            //     const url = URL.createObjectURL(blob);
                
            //     const downloadLink = document.createElement('a');
            //     downloadLink.href = url;
            //     downloadLink.download = 'data.json';
                
            //     document.body.appendChild(downloadLink);
            //     downloadLink.click();
            //     document.body.removeChild(downloadLink);
            // }

            async function updateData() {
                // Make a GET request to retrieve the data from MongoDB
                const response = await fetch('http://localhost:3000/package/64401f562953ae67a2ef6a32');
                const dataString = await response.text();

                const data = JSON.parse(dataString);

                console.log(data.data.Content)  

                // Convert the array to a JSON string and create a Blob object
                const contentString = data.data.Content;
                const contentBlob = new Blob([contentString], { type: 'application/json' });

                //const decodedContent = Buffer.from(base64Content, 'base64')
                //const zip = await JSZip.loadAsync(decodedContent)
                var binaryString = atob(contentString);
                var buffer = new ArrayBuffer(binaryString.length);
                var view = new Uint8Array(buffer);

                for (var i = 0; i < binaryString.length; i++) {
                view[i] = binaryString.charCodeAt(i);
                }

                var decoder = new TextDecoder();
                var decodedString = decoder.decode(buffer);

                // Create a zip file containing the JSON content
                const zip = new JSZip();
                // zip.file('content.json', testData);

                // Generate a download URL for the zip file
                // const zipBlob = await zip.generateAsync({ type: 'blob' });
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(zipBlob);

                // Create a link element and trigger the download when it's clicked
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = 'data.zip';
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            }
        </script>
    </body>
</html>